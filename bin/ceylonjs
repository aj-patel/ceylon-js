#!/bin/sh

# resolve links - $0 may be a softlink
PRG="$0"
while [ -h "$PRG" ]; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`/"$link"
  fi
done

DIR=$(dirname "$PRG")

# Only set CEYLON_HOME if not already set
if test -z "$CEYLON_HOME"
then
    CEYLON_HOME="$DIR/.."
fi

. $DIR/c-js.sh

# Set CEYLON_HOME if not already set by the user
if test -z "$CEYLON_HOME"
then
    CEYLON_HOME="$(dirname "$PRG)")/.."
fi

# Set CEYLON_REPO if not already set
if test -z "$CEYLON_REPO"
then
    # Try the distribution repo
    CEYLON_REPO="$CEYLON_HOME/repo"
    # If it does not exist let's use the user repo
    if test \! -d "$CEYLON_REPO"
    then
        echo "Could not find distribution repo, using $HOME/.ceylon/repo"
        CEYLON_REPO="$HOME/.ceylon/repo"
    fi
fi

#Default place to look for modules (besides bootstrap repo)
MODS=modules
#Default function to run
FUN=run
#Default version
MPATH=$MOD
MVER=1.0.0
while getopts p:m:v:f: o
do	case "$o" in
	m)	MOD="$OPTARG";;
	f)	FUN="$OPTARG";;
	p)	MODS="$OPTARG";;
	v)	MVER="$OPTARG";;
	[?]) echo >%2 "Usage: $0 [-p path to modules directory] [-m module to run] [-v module version] [-f function to run]"
         exit 1;;
	esac
done

if test -z "$MOD"
then
	echo "Usage:"
	echo "      ceylonjs [-p path to modules directory] [-m module to run] [-v module version] [-f function to run]"
	echo "          -p defaults to ./modules"
	echo "          -f defaults to 'run' which must be an exported function of the JS module"
	echo "          -v defaults to 1.0.0"
    exit
fi

if [ "$MOD" != "default" ]; then
  MPATH="$MOD/$MVER"
  MOD="$MOD-$MVER"
fi

NODE_PATH=$NODEPATH:$CEYLON_REPO:$MODS node -e "require('$MPATH/$MOD').${FUN}();"
